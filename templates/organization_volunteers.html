{% extends "base.html" %}

{% block title %}Volunteers - VolunteerHub{% endblock %}

{% block extra_css %}
<style>
    /* Hide main site navigation */
    #navbar {
        display: none;
    }
    
    body {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
    }

    .org-container {
        max-width: 1600px;
        margin: 40px auto 60px;
        padding: 0 60px;
    }

    .org-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }

    .org-header h1 {
        color: #0f4c5c;
        font-size: 36px;
        display: flex;
        align-items: center;
        gap: 15px;
        margin: 0;
    }

    .logout-btn {
        padding: 10px 20px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none;
    }

    .logout-btn:hover {
        background: #c82333;
    }

    .org-nav {
        display: flex;
        gap: 20px;
        margin-bottom: 40px;
    }

    .org-nav a {
        padding: 12px 24px;
        background: white;
        color: #0f4c5c;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .org-nav a:hover {
        background: #0f4c5c;
        color: white;
        transform: translateY(-2px);
    }

    .org-nav a.active {
        background: linear-gradient(135deg, #5fb3c5 0%, #0f4c5c 100%);
        color: white;
    }

    
    .volunteers-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .filter-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .filter-row {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-input {
        flex: 1;
        min-width: 200px;
        padding: 0.75rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
    }
    
    .filter-input:focus {
        border-color: #5fb3c5;
        outline: none;
    }
    
    .filter-select {
        min-width: 200px;
        padding: 0.75rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
    }
    
    .volunteers-table {
        width: 100%;
        margin-top: 1rem;
    }
    
    .volunteers-table thead {
        background: linear-gradient(135deg, #5fb3c5, #0f4c5c);
        color: white;
    }
    
    .volunteers-table th {
        padding: 1rem;
        font-weight: 600;
        text-align: left;
    }
    
    .volunteers-table td {
        padding: 1rem;
        border-bottom: 1px solid #eee;
    }
    
    .volunteers-table tbody tr {
        transition: background 0.2s;
    }
    
    .volunteers-table tbody tr:hover {
        background: rgba(95, 179, 197, 0.05);
    }
    
    .volunteer-name {
        font-weight: 600;
        color: #0f4c5c;
    }
    
    .volunteer-email {
        color: #666;
        font-size: 0.9rem;
    }
    
    .badge-bookings {
        background: linear-gradient(135deg, #5fb3c5, #0f4c5c);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .opportunity-tag {
        display: inline-block;
        background: #e9ecef;
        color: #0f4c5c;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.85rem;
        margin: 0.25rem;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-card i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #5fb3c5, #0f4c5c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .stat-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: #0f4c5c;
    }
    
    .stat-card .label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #ccc;
        margin-bottom: 1rem;
    }
    
    .btn-export {
        background: linear-gradient(135deg, #5fb3c5, #0f4c5c);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(95, 179, 197, 0.3);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="org-container">
    <div class="org-header">
        <h1>👥 Volunteers</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button class="btn btn-export" onclick="exportVolunteers()">
                <i class="fas fa-download"></i> Export List
            </button>
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>
    </div>

    <!-- Organization Navigation Bar -->
    <div class="org-nav">
        <a href="{{ url_for('organization_dashboard') }}">Dashboard</a>
        <a href="{{ url_for('organization_opportunities') }}">My Opportunities</a>
        <a href="{{ url_for('organization_volunteers') }}" class="active">Volunteers</a>
        <a href="{{ url_for('organization_profile') }}">Profile</a>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <div class="value">{{ volunteers|length }}</div>
            <div class="label">Total Volunteers</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-calendar-check"></i>
            <div class="value">{{ total_bookings }}</div>
            <div class="label">Total Bookings</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-clock"></i>
            <div class="value">{{ total_hours }}</div>
            <div class="label">Volunteer Hours</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-star"></i>
            <div class="value">{{ (total_hours / volunteers|length)|round(1) if volunteers|length > 0 else 0 }}</div>
            <div class="label">Avg Hours/Volunteer</div>
        </div>
    </div>
    
    <!-- Volunteers Table -->
    <div class="volunteers-container">
        <h3 style="color: #0f4c5c; margin-bottom: 1.5rem;">
            <i class="fas fa-list"></i> Volunteer List
        </h3>
        
        <!-- Filters -->
        <div class="filter-section">
            <div class="filter-row">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="filter-input" 
                    placeholder="🔍 Search by name or email..."
                    onkeyup="filterVolunteers()"
                >
                <select id="opportunityFilter" class="filter-select" onchange="filterVolunteers()">
                    <option value="">All Opportunities</option>
                    {% for opp in opportunities %}
                    <option value="{{ opp.title }}">{{ opp.title }}</option>
                    {% endfor %}
                </select>
                <select id="sortBy" class="filter-select" onchange="sortVolunteers()">
                    <option value="name">Sort by Name</option>
                    <option value="bookings">Sort by Bookings</option>
                    <option value="hours">Sort by Hours</option>
                    <option value="recent">Most Recent</option>
                </select>
            </div>
        </div>
        
        {% if volunteers %}
        <table class="volunteers-table" id="volunteersTable">
            <thead>
                <tr>
                    <th>Volunteer</th>
                    <th>Contact</th>
                    <th>Opportunities</th>
                    <th>Bookings</th>
                    <th>Hours</th>
                    <th>Last Activity</th>
                </tr>
            </thead>
            <tbody>
                {% for volunteer in volunteers %}
                <tr data-name="{{ volunteer.full_name }}" data-email="{{ volunteer.email }}">
                    <td>
                        <div class="volunteer-name">{{ volunteer.full_name }}</div>
                    </td>
                    <td>
                        <div class="volunteer-email">{{ volunteer.email }}</div>
                    </td>
                    <td>
                        <div style="max-width: 300px;">
                            {% for booking in volunteer.bookings %}
                                {% if booking.opportunity.organization_id == current_user.organization_id %}
                                <span class="opportunity-tag">{{ booking.opportunity.title }}</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <span class="badge-bookings">
                            {{ volunteer.bookings|selectattr('opportunity.organization_id', 'equalto', current_user.organization_id)|list|length }}
                        </span>
                    </td>
                    <td>
                        <strong>
                            {% set hours = volunteer.bookings|selectattr('opportunity.organization_id', 'equalto', current_user.organization_id)|map(attribute='opportunity.hours')|sum %}
                            {{ hours }}h
                        </strong>
                    </td>
                    <td>
                        {% set latest_booking = volunteer.bookings|selectattr('opportunity.organization_id', 'equalto', current_user.organization_id)|list|sort(attribute='created_at', reverse=true)|first %}
                        {% if latest_booking %}
                        {{ latest_booking.created_at.strftime('%b %d, %Y') }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-user-friends"></i>
            <h3>No Volunteers Yet</h3>
            <p>Volunteers who book your opportunities will appear here.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function filterVolunteers() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const opportunityFilter = document.getElementById('opportunityFilter').value.toLowerCase();
    const table = document.getElementById('volunteersTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const name = row.getAttribute('data-name').toLowerCase();
        const email = row.getAttribute('data-email').toLowerCase();
        const opportunities = row.cells[2].textContent.toLowerCase();
        
        const matchesSearch = name.includes(searchInput) || email.includes(searchInput);
        const matchesOpportunity = !opportunityFilter || opportunities.includes(opportunityFilter);
        
        if (matchesSearch && matchesOpportunity) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

function sortVolunteers() {
    const sortBy = document.getElementById('sortBy').value;
    const table = document.getElementById('volunteersTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    rows.sort((a, b) => {
        switch(sortBy) {
            case 'name':
                return a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'));
            case 'bookings':
                const bookingsA = parseInt(a.cells[3].textContent);
                const bookingsB = parseInt(b.cells[3].textContent);
                return bookingsB - bookingsA;
            case 'hours':
                const hoursA = parseInt(a.cells[4].textContent);
                const hoursB = parseInt(b.cells[4].textContent);
                return hoursB - hoursA;
            case 'recent':
                const dateA = a.cells[5].textContent;
                const dateB = b.cells[5].textContent;
                return dateB.localeCompare(dateA);
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function exportVolunteers() {
    // Prepare CSV data
    let csv = 'Name,Email,Bookings,Hours,Last Activity\n';
    const table = document.getElementById('volunteersTable');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        if (rows[i].style.display !== 'none') {
            const cells = rows[i].getElementsByTagName('td');
            const name = rows[i].getAttribute('data-name');
            const email = rows[i].getAttribute('data-email');
            const bookings = cells[3].textContent.trim();
            const hours = cells[4].textContent.trim();
            const lastActivity = cells[5].textContent.trim();
            
            csv += `"${name}","${email}","${bookings}","${hours}","${lastActivity}"\n`;
        }
    }
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'volunteers_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
